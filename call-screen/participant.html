<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        #callScreenWidgetContainer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 10;
            background-color: gray;
        }
        video {
            border: 2px solid red;
        }
    </style>
</head>
<body>
<div id="callScreenWidgetContainer"></div>

<script>
    window.addEventListener('load', function() {
        // Get session ID from localStorage
        const videoSessionId = localStorage.getItem('videoSessionId');
        if (!videoSessionId) {
            alert('No session ID found. Please go back to the main page and enter a session ID.');
            window.location.href = '/call-screen/';
            return;
        }

        const postMessageHandler = (event) => {
            switch (event.data?.type) {
                case 'CALL_SCREEN_WIDGET_SESSION_CLOSED':
                case 'CALL_SCREEN_WIDGET_SESSION_FINISHED':
                case 'CALL_SCREEN_WIDGET_HUNG_UP':
                case 'CALL_SCREEN_WIDGET_INITIALIZED':
                case 'CALL_SCREEN_WIDGET_JOINED_THE_CALL':
                case 'CALL_SCREEN_WIDGET_START_SESSION_ERROR':
                case 'CALL_SCREEN_WIDGET_CALL_INITIALIZATION_FAILED':
                case 'CALL_SCREEN_WIDGET_MUTE_SUCCESS':
                case 'CALL_SCREEN_WIDGET_MUTE_ERROR':
                case 'CALL_SCREEN_WIDGET_UNMUTE_SUCCESS':
                case 'CALL_SCREEN_WIDGET_UNMUTE_ERROR':
                case 'CALL_SCREEN_WIDGET_CAMERA_ON_SUCCESS':
                case 'CALL_SCREEN_WIDGET_CAMERA_ON_ERROR':
                case 'CALL_SCREEN_WIDGET_CAMERA_OFF_SUCCESS':
                case 'CALL_SCREEN_WIDGET_CAMERA_OFF_ERROR':
                case 'CALL_SCREEN_WIDGET_NEXT_CAMERA_SUCCESS':
                case 'CALL_SCREEN_WIDGET_NEXT_CAMERA_ERROR':
                case 'CALL_SCREEN_WIDGET_FINISH_SESSION_SUCCESS':
                case 'CALL_SCREEN_WIDGET_FINISH_SESSION_ERROR':
                case 'CALL_SCREEN_WIDGET_APPLY_LAYOUT_SUCCESS':
                case 'CALL_SCREEN_WIDGET_SOCKET_CONNECTION_FAILED':
                case 'CALL_SCREEN_WIDGET_APPLY_LAYOUT_ERROR':
                    console.log(`Received message: ${event.data.type}`, event.data);
                    break;
                default:
                    break;
            }
        };
        
        const postMessageHandlerBound = postMessageHandler.bind(this);
        window.addEventListener('message', postMessageHandlerBound);

        const visibleElements = JSON.stringify({
            participantsPanel: {
                enabled: true
            },
            waitingRoom: {
                enabled: true
            },
            controlPanel: {
                enabled: true
            }
        }).replace(/"/g, '&quot;');

        const script = document.createElement('script');
        script.src = "https://widgets.dev.xpertyme.com/call-screen/widget.js";
        script.onload = function() {
            const autoJoinParticipant = localStorage.getItem('autoJoinParticipant') === 'true';
            const layout = localStorage.getItem('layout') || 'XPT'; // Default to XPT if not set
            const widgetHtml = `<call-screen id="callScreen"
                    data-video-session-id="${videoSessionId}"
                    data-participant-id="${localStorage.getItem('participantId') || ''}"
                    data-auth-token="${localStorage.getItem('participantAuthToken') || ''}"
                    data-api-domain-name="https://call-api.dev.xpertyme.com"
                    data-layout="${layout}"
                    data-locale="en"
                    data-primary-color="#10B981"
                    data-waiting-room-background-color="gray"
                    data-session-title="Participant"
                    data-visible-elements="${visibleElements}"
                    data-autostart-call="${autoJoinParticipant}"
                    data-auto-join-call="${autoJoinParticipant}">
                </call-screen>`;
            
            const container = document.getElementById('callScreenWidgetContainer');
            container.innerHTML = widgetHtml;
        };

        document.body.appendChild(script);
    });
</script>
</body>
</html>
